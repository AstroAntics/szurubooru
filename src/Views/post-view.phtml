<?php
CustomAssetViewDecorator::setSubTitle('showing ' . TextHelper::reprPost($this->context->transport->post) . ' &ndash; ' . TextHelper::reprTags($this->context->transport->post->getTags()));
CustomAssetViewDecorator::addStylesheet('post-view.css');
CustomAssetViewDecorator::addScript('post-view.js');
CustomAssetViewDecorator::addStylesheet('../lib/tagit/jquery.tagit.css');
CustomAssetViewDecorator::addScript('../lib/tagit/jquery.tagit.js');

$editPostPrivileges = [
	Privilege::EditPostSafety,
	Privilege::EditPostTags,
	Privilege::EditPostThumb,
	Privilege::EditPostSource,
];
$editPostPrivileges = array_fill_keys($editPostPrivileges, false);
foreach (array_keys($editPostPrivileges) as $privilege)
{
	if (PrivilegesHelper::confirm($privilege, PrivilegesHelper::getIdentitySubPrivilege($this->context->transport->post->getUploader())))
		$editPostPrivileges[$privilege] = true;
}
$canEditAnything = count(array_filter($editPostPrivileges)) > 0;
?>

<div id="sidebar">
	<nav id="around">
		<div class="left">
			<?php if ($this->context->transport->nextPostId): ?>
				<a href="<?php echo \Chibi\UrlHelper::route('post', 'view', ['id' => $this->context->transport->nextPostId]) ?>">
			<?php else: ?>
				<a class="disabled">
			<?php endif ?>
				<i class="icon-next"></i>
				<span>next post</span>
			</a>
		</div>

		<div class="right">
			<?php if ($this->context->transport->prevPostId): ?>
				<a href="<?php echo \Chibi\UrlHelper::route('post', 'view', ['id' => $this->context->transport->prevPostId]) ?>">
			<?php else: ?>
				<a class="disabled">
			<?php endif ?>
				<span>prev post</span>
				<i class="icon-prev"></i>
			</a>
		</div>

		<div class="clear"></div>

		<?php if (!empty($this->context->transport->lastSearchQuery)): ?>
			<div class="text">
				Current&nbsp;search:<br/>
				<a href="<?php echo \Chibi\UrlHelper::route('post', 'list', ['query' => $this->context->transport->lastSearchQuery]) ?>"><?php echo $this->context->transport->lastSearchQuery ?></a>
			</div>
		<?php endif ?>
	</nav>

	<div class="unit tags">
		<?php $tags = $this->context->transport->post->getTags() ?>
		<h1>tags (<?php echo count($tags) ?>)</h1>
		<ul>
			<?php uasort($tags, function($a, $b) { return strnatcasecmp($a->name, $b->name); }) ?>
			<?php foreach ($tags as $tag): ?>
				<li title="<?php echo $tag->name ?>">
					<a href="<?php echo \Chibi\UrlHelper::route('post', 'list', ['query' => $tag->name]) ?>">
						<?php echo $tag->name ?>
					</a>
					<span class="count">
						<?php echo TextHelper::useDecimalUnits($tag->getPostCount()) ?>
					</span>
				</li>
			<?php endforeach ?>
		</ul>
	</div>

	<div class="unit details">
		<h1>details</h1>

		<div class="uploader">
			<?php $uploader = $this->context->transport->post->getUploader() ?>
			<?php if ($uploader): ?>
				<span class="value" title="<?php echo $val = $uploader->name ?>">
					<a href="<?php echo \Chibi\UrlHelper::route('user', 'view', ['name' => $uploader->name]) ?>">
						<img src="<?php echo htmlentities($uploader->getAvatarUrl(24)) ?>" alt="<?php echo $uploader->name ?>"/>
						<?php echo $val ?>
					</a>
				</span>
			<?php else: ?>
				<span class="value" title="<?php echo UserModel::getAnonymousName() ?>">
					<img src="<?php echo \Chibi\UrlHelper::absoluteUrl('/media/img/pixel.gif') ?>" alt="<?php echo UserModel::getAnonymousName() ?>"/>
					<?php echo UserModel::getAnonymousName() ?>
				</span>
			<?php endif ?>
			<br>
			<span class="date" title="<?php echo TextHelper::formatDate($this->context->transport->post->uploadDate, true) ?>">
				<?php echo TextHelper::formatDate($this->context->transport->post->uploadDate, false) ?>
			</span>
		</div>

		<div class="key-value safety">
			<span class="key">Safety:</span>
			<span class="value safety-<?php echo $val = TextHelper::camelCaseToHumanCase(PostSafety::toString($this->context->transport->post->safety)) ?>" title="<?php echo $val ?>">
				<?php echo $val ?>
			</span>
		</div>

		<div class="key-value source">
			<span class="key">Source:</span>
			<span class="value" title="<?php echo $val = htmlspecialchars($this->context->transport->post->source ?: 'unknown') ?>">
				<?php if (preg_match('/^((https?|ftp):|)\/\//', $this->context->transport->post->source)): ?>
					<a href="<?php echo $val ?>"><?php echo $val ?></a>
				<?php else: ?>
					<?php echo $val ?>
				<?php endif ?>
			</span>
		</div>

		<?php if ($this->context->transport->post->imageWidth > 0): ?>
			<div class="key-value dim">
				<span class="key">Dimensions:</span>
				<span class="value" title="<?php echo $val = sprintf('%dx%d',
					$this->context->transport->post->imageWidth,
					$this->context->transport->post->imageHeight) ?>">
					<?php echo $val ?>
				</span>
			</div>
		<?php endif ?>

		<div class="key-value score">
			<span class="key">Score:</span>
			<span class="value">
				<?php echo $this->context->transport->post->score ?>

				<?php if (PrivilegesHelper::confirm(Privilege::ScorePost, PrivilegesHelper::getIdentitySubPrivilege($this->context->transport->post->getUploader()))): ?>
					&nbsp;[
					<?php $scoreLink = function($score) { return \Chibi\UrlHelper::route('post', 'score', ['id' => $this->context->transport->post->id, 'score' => $score]); } ?>

					<?php if ($this->context->score === 1): ?>
						<a class="simple-action selected" href="<?php echo $scoreLink(0) ?>">
					<?php else: ?>
						<a class="simple-action" href="<?php echo $scoreLink(1) ?>">
					<?php endif ?>
						vote up
					</a>

					,&nbsp;

					<?php if ($this->context->score === -1): ?>
						<a class="simple-action selected" href="<?php echo $scoreLink(0) ?>">
					<?php else: ?>
						<a class="simple-action" href="<?php echo $scoreLink(-1) ?>">
					<?php endif ?>
						down
					</a>]
				<?php endif ?>
			</span>
		</div>
	</div>

	<div class="unit hl-options">
		<?php if ($this->context->transport->post->type != PostType::Youtube): ?>
			<div class="hl-option">
				<a href="<?php echo \Chibi\UrlHelper::route('post', 'retrieve', ['name' => $this->context->transport->post->name]) ?>" title="Download">
					<i class="icon-dl"></i>
					<span>
						<?php
							printf(
								'Download %s (%s)',
								strtoupper(TextHelper::resolveMimeType($this->context->transport->post->mimeType)) ?: 'Unknown',
								TextHelper::useBytesUnits($this->context->transport->post->fileSize));
						?>
					</span>
				</a>
			</div>
		<?php endif ?>

		<?php if (PrivilegesHelper::confirm(Privilege::FavoritePost, PrivilegesHelper::getIdentitySubPrivilege($this->context->transport->post->getUploader()))): ?>
			<div class="hl-option">
				<?php if (!$this->context->favorite): ?>
					<a class="add-fav icon simple-action" href="<?php echo \Chibi\UrlHelper::route('post', 'add-favorite', ['id' => $this->context->transport->post->id]) ?>">
						<i class="icon-fav"></i>
						<span>Add to favorites</span>
					</a>
				<?php else: ?>
					<a class="rem-fav icon simple-action" href="<?php echo \Chibi\UrlHelper::route('post', 'rem-favorite', ['id' => $this->context->transport->post->id]) ?>">
						<i class="icon-fav"></i>
						<span>Remove from favorites</span>
					</a>
				<?php endif ?>
			</div>
		<?php endif ?>

		<?php if ($canEditAnything): ?>
			<div class="hl-option">
				<a class="edit-post icon" href="#">
					<i class="icon-edit"></i>
					<span>Edit</span>
				</a>
			</div>
		<?php endif ?>
	</div>

	<?php if (count($this->context->transport->post->getFavorites()) > 0): ?>
		<div class="unit favorites">
			<h1>favorites (<?php echo count($this->context->transport->post->getFavorites()) ?>)</h1>
			<ul>
				<?php foreach ($this->context->transport->post->getFavorites() as $user): ?>
					<li>
						<a href="<?php echo \Chibi\UrlHelper::route('user', 'view', ['name' => $user->name]) ?>" title="<?php echo $user->name ?>">
							<img src="<?php echo htmlspecialchars($user->getAvatarUrl()) ?>" alt="<?php echo $user->name ?>">
						</a>
					</li>
				<?php endforeach ?>
			</ul>
		</div>
	<?php endif ?>

	<?php if (count($this->context->transport->post->getRelations())): ?>
		<div class="unit relations">
			<h1>related</h1>
			<ul>
				<?php foreach ($this->context->transport->post->getRelations() as $relatedPost): ?>
					<li>
						<a href="<?php echo \Chibi\UrlHelper::route('post', 'view', ['id' => $relatedPost->id]) ?>">
							@<?php echo $relatedPost->id ?>
						</a>
					</li>
				<?php endforeach ?>
			</ul>
		</div>
	<?php endif ?>

	<?php
		$options = [];

		if (PrivilegesHelper::confirm(Privilege::FeaturePost, PrivilegesHelper::getIdentitySubPrivilege($this->context->transport->post->getUploader())))
		{
			$options []=
			[
				'class' => 'feature',
				'text' => 'Feature on main page',
				'simple-action' => \Chibi\UrlHelper::route('post', 'feature', ['id' => $this->context->transport->post->id]),
				'data-confirm-text' => 'Are you sure you want to feature this post on the main page?',
				'data-redirect-url' => \Chibi\UrlHelper::route('index', 'index'),
			];
		}

		if (PrivilegesHelper::confirm(Privilege::FlagPost, PrivilegesHelper::getIdentitySubPrivilege($this->context->transport->post->getUploader())))
		{
			if ($this->context->flagged)
			{
				$options []=
				[
					'class' => 'flag',
					'text' => 'Flagged',
					'inactive' => true,
				];
			}
			else
			{
				$options []=
				[
					'class' => 'flag',
					'text' => 'Flag for moderator attention',
					'simple-action' => \Chibi\UrlHelper::route('post', 'flag', ['id' => $this->context->transport->post->id]),
					'data-confirm-text' => 'Are you sure you want to flag this post?',
				];
			}
		}

		if (PrivilegesHelper::confirm(Privilege::HidePost, PrivilegesHelper::getIdentitySubPrivilege($this->context->transport->post->getUploader())))
		{
			if ($this->context->transport->post->hidden)
			{
				$options []=
				[
					'class' => 'unhide',
					'text' => 'Unhide',
					'simple-action' => \Chibi\UrlHelper::route('post', 'unhide', ['id' => $this->context->transport->post->id]),
				];
			}
			else
			{
				$options []=
				[
					'class' => 'hide',
					'text' => 'Hide',
					'simple-action' => \Chibi\UrlHelper::route('post', 'hide', ['id' => $this->context->transport->post->id]),
				];
			}
		}

		if (PrivilegesHelper::confirm(Privilege::DeletePost, PrivilegesHelper::getIdentitySubPrivilege($this->context->transport->post->getUploader())))
		{
			$options []=
			[
				'class' => 'delete',
				'text' => 'Delete',
				'simple-action' => \Chibi\UrlHelper::route('post', 'delete', ['id' => $this->context->transport->post->id]),
				'data-confirm-text' => 'Are you sure you want to delete this post?',
				'data-redirect-url' => \Chibi\UrlHelper::route('post', 'list'),
			];
		}

		$this->context->options = $options;
		$this->renderFile('sidebar-options');
	?>
</div>

<div id="inner-content">
	<?php if ($canEditAnything): ?>
		<div class="unit edit-post">
			<?php $this->renderFile('post-edit') ?>
		</div>
	<?php endif ?>

	<div class="post-wrapper post-type-<?php echo strtolower(PostType::toString($this->context->transport->post->type)) ?>">
		<?php echo $this->renderFile('post-file-render') ?>
	</div>

	<?php
	CustomAssetViewDecorator::addStylesheet('comment-list.css');
	CustomAssetViewDecorator::addStylesheet('comment-small.css');
	?>
	<div class="comments-wrapper">
		<?php if (!empty($this->context->transport->post->getComments())): ?>
			<div class="unit comments">
				<h1>comments (<?php echo count($this->context->transport->post->getComments()) ?>)</h1>
				<div class="comments">
					<?php foreach ($this->context->transport->post->getComments() as $comment): ?>
						<?php $this->context->comment = $comment ?>
						<?php echo $this->renderFile('comment-small') ?>
					<?php endforeach ?>
				</div>
			</div>
		<?php endif ?>
	</div>

	<?php if (PrivilegesHelper::confirm(Privilege::AddComment)): ?>
		<div class="unit comment-add">
			<?php $this->renderFile('comment-add') ?>
		</div>
	<?php endif ?>
</div>
